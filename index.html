<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Servo Monitor IoT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* ========= CONFIG FIREBASE ========= */
const firebaseConfig = {
  apiKey: "TU_API_KEY",
  databaseURL: "https://webcontrol-dcbcd-default-rtdb.firebaseio.com"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ========= REFERENCIAS ========= */
const servoRef = ref(db, "servo");
const notesRef = ref(db, "servo/notes");

/* ========= VARIABLES ========= */
let angle = 10;
let lastSignalTime = 0;
let esp32Connected = false;

/* ========= CANVAS ========= */
const canvas = document.getElementById("servoCanvas");
const ctx = canvas.getContext("2d");

/* ========= ESCUCHA ESP32 ========= */
onValue(servoRef, (snap) => {
  const data = snap.val();
  if (!data) return;

  angle = data.angle ?? angle;

  if (data.signal === true) {
    lastSignalTime = Date.now();
  }

  updateUI();
});

/* ========= VERIFICAR CONEXIÃ“N ========= */
setInterval(() => {
  esp32Connected = (Date.now() - lastSignalTime) < 3000;
  updateUI();
}, 1000);

/* ========= SIMULADOR ========= */
window.simulateServo = () => {
  if (esp32Connected) return;

  angle = angle === 10 ? 170 : 10;

  set(servoRef, {
    angle: angle,
    signal: false
  });
};

/* ========= FECHA Y HORA ========= */
function updateDateTime() {
  const now = new Date();
  document.getElementById("time").textContent = now.toLocaleTimeString();
  document.getElementById("date").textContent = now.toLocaleDateString();
}
setInterval(updateDateTime, 1000);
updateDateTime();

/* ========= OBSERVACIONES ========= */
document.getElementById("notes").addEventListener("change", (e) => {
  set(notesRef, e.target.value);
});

onValue(notesRef, (snap) => {
  if (snap.exists()) {
    document.getElementById("notes").value = snap.val();
  }
});

/* ========= ACTUALIZAR UI ========= */
function updateUI() {
  document.getElementById("angle").textContent = angle + "Â°";

  const status = document.getElementById("status");
  const btn = document.getElementById("simBtn");

  if (esp32Connected) {
    status.textContent = "ğŸŸ¢ ESP32 CONECTADO";
    status.className = "text-green-400 font-bold";
    btn.disabled = true;
    btn.classList.add("opacity-50");
  } else {
    status.textContent = "ğŸ”´ SIN SEÃ‘AL DEL ESP32";
    status.className = "text-red-400 font-bold";
    btn.disabled = false;
    btn.classList.remove("opacity-50");
  }

  drawServo();
}

/* ========= DIBUJO DEL SERVO ========= */
function drawServo() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  ctx.save();
  ctx.translate(150, 140);
  ctx.rotate(-angle * Math.PI / 180);

  ctx.strokeStyle = "black";
  ctx.lineWidth = 6;
  ctx.beginPath();
  ctx.moveTo(0, 0);
  ctx.lineTo(0, -80);
  ctx.stroke();

  ctx.restore();
}
</script>
</head>

<body class="bg-slate-900 text-white h-screen flex items-center justify-center">

<div class="bg-slate-800 p-6 rounded-xl space-y-4 w-96 text-center">

  <h1 class="text-xl font-bold">ğŸ¦¾ Servo Monitor IoT</h1>

  <!-- FECHA Y HORA -->
  <div class="flex justify-between text-sm text-slate-300">
    <span id="date">--/--/----</span>
    <span id="time">--:--:--</span>
  </div>

  <!-- ESTADO -->
  <p id="status" class="text-red-400 font-bold">ğŸ”´ SIN SEÃ‘AL DEL ESP32</p>

  <!-- CANVAS -->
  <canvas id="servoCanvas" width="300" height="200"
    class="bg-white rounded mx-auto"></canvas>

  <!-- ÃNGULO -->
  <p class="text-lg">Ãngulo: <span id="angle">10Â°</span></p>

  <!-- BOTÃ“N SIMULADOR -->
  <button id="simBtn" onclick="simulateServo()"
    class="w-full bg-blue-600 py-3 rounded hover:bg-blue-700 transition">
    â–¶ Simular Movimiento
  </button>

  <!-- OBSERVACIONES -->
  <div class="text-left">
    <label class="text-sm text-slate-300">ğŸ“ Observaciones</label>
    <textarea id="notes"
      class="w-full mt-1 p-2 rounded bg-slate-700 text-white focus:outline-none"
      rows="3"
      placeholder="Escriba observaciones del sistema...">
    </textarea>
  </div>

</div>

</body>
</html>
